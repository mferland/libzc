/*
 *  zc - zip crack library
 *  Copyright (C) 2012-2023 Marc Ferland
 *
 *  This program is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

/*
 * Stolen from:
 * https://github.com/lemire/Code-used-on-Daniel-Lemire-s-blog/blob/master/2017/04/10/removeduplicates.cpp
 */

#include <stdint.h>
#include "libzc_private.h"

#if defined(__AVX2__)

#include <x86intrin.h>

uint32_t uniqshuf[] = {
	0, 1, 2, 3, 4, 5, 6, 7,
	1, 2, 3, 4, 5, 6, 7, 0,
	0, 2, 3, 4, 5, 6, 7, 0,
	2, 3, 4, 5, 6, 7, 0, 0,
	0, 1, 3, 4, 5, 6, 7, 0,
	1, 3, 4, 5, 6, 7, 0, 0,
	0, 3, 4, 5, 6, 7, 0, 0,
	3, 4, 5, 6, 7, 0, 0, 0,
	0, 1, 2, 4, 5, 6, 7, 0,
	1, 2, 4, 5, 6, 7, 0, 0,
	0, 2, 4, 5, 6, 7, 0, 0,
	2, 4, 5, 6, 7, 0, 0, 0,
	0, 1, 4, 5, 6, 7, 0, 0,
	1, 4, 5, 6, 7, 0, 0, 0,
	0, 4, 5, 6, 7, 0, 0, 0,
	4, 5, 6, 7, 0, 0, 0, 0,
	0, 1, 2, 3, 5, 6, 7, 0,
	1, 2, 3, 5, 6, 7, 0, 0,
	0, 2, 3, 5, 6, 7, 0, 0,
	2, 3, 5, 6, 7, 0, 0, 0,
	0, 1, 3, 5, 6, 7, 0, 0,
	1, 3, 5, 6, 7, 0, 0, 0,
	0, 3, 5, 6, 7, 0, 0, 0,
	3, 5, 6, 7, 0, 0, 0, 0,
	0, 1, 2, 5, 6, 7, 0, 0,
	1, 2, 5, 6, 7, 0, 0, 0,
	0, 2, 5, 6, 7, 0, 0, 0,
	2, 5, 6, 7, 0, 0, 0, 0,
	0, 1, 5, 6, 7, 0, 0, 0,
	1, 5, 6, 7, 0, 0, 0, 0,
	0, 5, 6, 7, 0, 0, 0, 0,
	5, 6, 7, 0, 0, 0, 0, 0,
	0, 1, 2, 3, 4, 6, 7, 0,
	1, 2, 3, 4, 6, 7, 0, 0,
	0, 2, 3, 4, 6, 7, 0, 0,
	2, 3, 4, 6, 7, 0, 0, 0,
	0, 1, 3, 4, 6, 7, 0, 0,
	1, 3, 4, 6, 7, 0, 0, 0,
	0, 3, 4, 6, 7, 0, 0, 0,
	3, 4, 6, 7, 0, 0, 0, 0,
	0, 1, 2, 4, 6, 7, 0, 0,
	1, 2, 4, 6, 7, 0, 0, 0,
	0, 2, 4, 6, 7, 0, 0, 0,
	2, 4, 6, 7, 0, 0, 0, 0,
	0, 1, 4, 6, 7, 0, 0, 0,
	1, 4, 6, 7, 0, 0, 0, 0,
	0, 4, 6, 7, 0, 0, 0, 0,
	4, 6, 7, 0, 0, 0, 0, 0,
	0, 1, 2, 3, 6, 7, 0, 0,
	1, 2, 3, 6, 7, 0, 0, 0,
	0, 2, 3, 6, 7, 0, 0, 0,
	2, 3, 6, 7, 0, 0, 0, 0,
	0, 1, 3, 6, 7, 0, 0, 0,
	1, 3, 6, 7, 0, 0, 0, 0,
	0, 3, 6, 7, 0, 0, 0, 0,
	3, 6, 7, 0, 0, 0, 0, 0,
	0, 1, 2, 6, 7, 0, 0, 0,
	1, 2, 6, 7, 0, 0, 0, 0,
	0, 2, 6, 7, 0, 0, 0, 0,
	2, 6, 7, 0, 0, 0, 0, 0,
	0, 1, 6, 7, 0, 0, 0, 0,
	1, 6, 7, 0, 0, 0, 0, 0,
	0, 6, 7, 0, 0, 0, 0, 0,
	6, 7, 0, 0, 0, 0, 0, 0,
	0, 1, 2, 3, 4, 5, 7, 0,
	1, 2, 3, 4, 5, 7, 0, 0,
	0, 2, 3, 4, 5, 7, 0, 0,
	2, 3, 4, 5, 7, 0, 0, 0,
	0, 1, 3, 4, 5, 7, 0, 0,
	1, 3, 4, 5, 7, 0, 0, 0,
	0, 3, 4, 5, 7, 0, 0, 0,
	3, 4, 5, 7, 0, 0, 0, 0,
	0, 1, 2, 4, 5, 7, 0, 0,
	1, 2, 4, 5, 7, 0, 0, 0,
	0, 2, 4, 5, 7, 0, 0, 0,
	2, 4, 5, 7, 0, 0, 0, 0,
	0, 1, 4, 5, 7, 0, 0, 0,
	1, 4, 5, 7, 0, 0, 0, 0,
	0, 4, 5, 7, 0, 0, 0, 0,
	4, 5, 7, 0, 0, 0, 0, 0,
	0, 1, 2, 3, 5, 7, 0, 0,
	1, 2, 3, 5, 7, 0, 0, 0,
	0, 2, 3, 5, 7, 0, 0, 0,
	2, 3, 5, 7, 0, 0, 0, 0,
	0, 1, 3, 5, 7, 0, 0, 0,
	1, 3, 5, 7, 0, 0, 0, 0,
	0, 3, 5, 7, 0, 0, 0, 0,
	3, 5, 7, 0, 0, 0, 0, 0,
	0, 1, 2, 5, 7, 0, 0, 0,
	1, 2, 5, 7, 0, 0, 0, 0,
	0, 2, 5, 7, 0, 0, 0, 0,
	2, 5, 7, 0, 0, 0, 0, 0,
	0, 1, 5, 7, 0, 0, 0, 0,
	1, 5, 7, 0, 0, 0, 0, 0,
	0, 5, 7, 0, 0, 0, 0, 0,
	5, 7, 0, 0, 0, 0, 0, 0,
	0, 1, 2, 3, 4, 7, 0, 0,
	1, 2, 3, 4, 7, 0, 0, 0,
	0, 2, 3, 4, 7, 0, 0, 0,
	2, 3, 4, 7, 0, 0, 0, 0,
	0, 1, 3, 4, 7, 0, 0, 0,
	1, 3, 4, 7, 0, 0, 0, 0,
	0, 3, 4, 7, 0, 0, 0, 0,
	3, 4, 7, 0, 0, 0, 0, 0,
	0, 1, 2, 4, 7, 0, 0, 0,
	1, 2, 4, 7, 0, 0, 0, 0,
	0, 2, 4, 7, 0, 0, 0, 0,
	2, 4, 7, 0, 0, 0, 0, 0,
	0, 1, 4, 7, 0, 0, 0, 0,
	1, 4, 7, 0, 0, 0, 0, 0,
	0, 4, 7, 0, 0, 0, 0, 0,
	4, 7, 0, 0, 0, 0, 0, 0,
	0, 1, 2, 3, 7, 0, 0, 0,
	1, 2, 3, 7, 0, 0, 0, 0,
	0, 2, 3, 7, 0, 0, 0, 0,
	2, 3, 7, 0, 0, 0, 0, 0,
	0, 1, 3, 7, 0, 0, 0, 0,
	1, 3, 7, 0, 0, 0, 0, 0,
	0, 3, 7, 0, 0, 0, 0, 0,
	3, 7, 0, 0, 0, 0, 0, 0,
	0, 1, 2, 7, 0, 0, 0, 0,
	1, 2, 7, 0, 0, 0, 0, 0,
	0, 2, 7, 0, 0, 0, 0, 0,
	2, 7, 0, 0, 0, 0, 0, 0,
	0, 1, 7, 0, 0, 0, 0, 0,
	1, 7, 0, 0, 0, 0, 0, 0,
	0, 7, 0, 0, 0, 0, 0, 0,
	7, 0, 0, 0, 0, 0, 0, 0,
	0, 1, 2, 3, 4, 5, 6, 0,
	1, 2, 3, 4, 5, 6, 0, 0,
	0, 2, 3, 4, 5, 6, 0, 0,
	2, 3, 4, 5, 6, 0, 0, 0,
	0, 1, 3, 4, 5, 6, 0, 0,
	1, 3, 4, 5, 6, 0, 0, 0,
	0, 3, 4, 5, 6, 0, 0, 0,
	3, 4, 5, 6, 0, 0, 0, 0,
	0, 1, 2, 4, 5, 6, 0, 0,
	1, 2, 4, 5, 6, 0, 0, 0,
	0, 2, 4, 5, 6, 0, 0, 0,
	2, 4, 5, 6, 0, 0, 0, 0,
	0, 1, 4, 5, 6, 0, 0, 0,
	1, 4, 5, 6, 0, 0, 0, 0,
	0, 4, 5, 6, 0, 0, 0, 0,
	4, 5, 6, 0, 0, 0, 0, 0,
	0, 1, 2, 3, 5, 6, 0, 0,
	1, 2, 3, 5, 6, 0, 0, 0,
	0, 2, 3, 5, 6, 0, 0, 0,
	2, 3, 5, 6, 0, 0, 0, 0,
	0, 1, 3, 5, 6, 0, 0, 0,
	1, 3, 5, 6, 0, 0, 0, 0,
	0, 3, 5, 6, 0, 0, 0, 0,
	3, 5, 6, 0, 0, 0, 0, 0,
	0, 1, 2, 5, 6, 0, 0, 0,
	1, 2, 5, 6, 0, 0, 0, 0,
	0, 2, 5, 6, 0, 0, 0, 0,
	2, 5, 6, 0, 0, 0, 0, 0,
	0, 1, 5, 6, 0, 0, 0, 0,
	1, 5, 6, 0, 0, 0, 0, 0,
	0, 5, 6, 0, 0, 0, 0, 0,
	5, 6, 0, 0, 0, 0, 0, 0,
	0, 1, 2, 3, 4, 6, 0, 0,
	1, 2, 3, 4, 6, 0, 0, 0,
	0, 2, 3, 4, 6, 0, 0, 0,
	2, 3, 4, 6, 0, 0, 0, 0,
	0, 1, 3, 4, 6, 0, 0, 0,
	1, 3, 4, 6, 0, 0, 0, 0,
	0, 3, 4, 6, 0, 0, 0, 0,
	3, 4, 6, 0, 0, 0, 0, 0,
	0, 1, 2, 4, 6, 0, 0, 0,
	1, 2, 4, 6, 0, 0, 0, 0,
	0, 2, 4, 6, 0, 0, 0, 0,
	2, 4, 6, 0, 0, 0, 0, 0,
	0, 1, 4, 6, 0, 0, 0, 0,
	1, 4, 6, 0, 0, 0, 0, 0,
	0, 4, 6, 0, 0, 0, 0, 0,
	4, 6, 0, 0, 0, 0, 0, 0,
	0, 1, 2, 3, 6, 0, 0, 0,
	1, 2, 3, 6, 0, 0, 0, 0,
	0, 2, 3, 6, 0, 0, 0, 0,
	2, 3, 6, 0, 0, 0, 0, 0,
	0, 1, 3, 6, 0, 0, 0, 0,
	1, 3, 6, 0, 0, 0, 0, 0,
	0, 3, 6, 0, 0, 0, 0, 0,
	3, 6, 0, 0, 0, 0, 0, 0,
	0, 1, 2, 6, 0, 0, 0, 0,
	1, 2, 6, 0, 0, 0, 0, 0,
	0, 2, 6, 0, 0, 0, 0, 0,
	2, 6, 0, 0, 0, 0, 0, 0,
	0, 1, 6, 0, 0, 0, 0, 0,
	1, 6, 0, 0, 0, 0, 0, 0,
	0, 6, 0, 0, 0, 0, 0, 0,
	6, 0, 0, 0, 0, 0, 0, 0,
	0, 1, 2, 3, 4, 5, 0, 0,
	1, 2, 3, 4, 5, 0, 0, 0,
	0, 2, 3, 4, 5, 0, 0, 0,
	2, 3, 4, 5, 0, 0, 0, 0,
	0, 1, 3, 4, 5, 0, 0, 0,
	1, 3, 4, 5, 0, 0, 0, 0,
	0, 3, 4, 5, 0, 0, 0, 0,
	3, 4, 5, 0, 0, 0, 0, 0,
	0, 1, 2, 4, 5, 0, 0, 0,
	1, 2, 4, 5, 0, 0, 0, 0,
	0, 2, 4, 5, 0, 0, 0, 0,
	2, 4, 5, 0, 0, 0, 0, 0,
	0, 1, 4, 5, 0, 0, 0, 0,
	1, 4, 5, 0, 0, 0, 0, 0,
	0, 4, 5, 0, 0, 0, 0, 0,
	4, 5, 0, 0, 0, 0, 0, 0,
	0, 1, 2, 3, 5, 0, 0, 0,
	1, 2, 3, 5, 0, 0, 0, 0,
	0, 2, 3, 5, 0, 0, 0, 0,
	2, 3, 5, 0, 0, 0, 0, 0,
	0, 1, 3, 5, 0, 0, 0, 0,
	1, 3, 5, 0, 0, 0, 0, 0,
	0, 3, 5, 0, 0, 0, 0, 0,
	3, 5, 0, 0, 0, 0, 0, 0,
	0, 1, 2, 5, 0, 0, 0, 0,
	1, 2, 5, 0, 0, 0, 0, 0,
	0, 2, 5, 0, 0, 0, 0, 0,
	2, 5, 0, 0, 0, 0, 0, 0,
	0, 1, 5, 0, 0, 0, 0, 0,
	1, 5, 0, 0, 0, 0, 0, 0,
	0, 5, 0, 0, 0, 0, 0, 0,
	5, 0, 0, 0, 0, 0, 0, 0,
	0, 1, 2, 3, 4, 0, 0, 0,
	1, 2, 3, 4, 0, 0, 0, 0,
	0, 2, 3, 4, 0, 0, 0, 0,
	2, 3, 4, 0, 0, 0, 0, 0,
	0, 1, 3, 4, 0, 0, 0, 0,
	1, 3, 4, 0, 0, 0, 0, 0,
	0, 3, 4, 0, 0, 0, 0, 0,
	3, 4, 0, 0, 0, 0, 0, 0,
	0, 1, 2, 4, 0, 0, 0, 0,
	1, 2, 4, 0, 0, 0, 0, 0,
	0, 2, 4, 0, 0, 0, 0, 0,
	2, 4, 0, 0, 0, 0, 0, 0,
	0, 1, 4, 0, 0, 0, 0, 0,
	1, 4, 0, 0, 0, 0, 0, 0,
	0, 4, 0, 0, 0, 0, 0, 0,
	4, 0, 0, 0, 0, 0, 0, 0,
	0, 1, 2, 3, 0, 0, 0, 0,
	1, 2, 3, 0, 0, 0, 0, 0,
	0, 2, 3, 0, 0, 0, 0, 0,
	2, 3, 0, 0, 0, 0, 0, 0,
	0, 1, 3, 0, 0, 0, 0, 0,
	1, 3, 0, 0, 0, 0, 0, 0,
	0, 3, 0, 0, 0, 0, 0, 0,
	3, 0, 0, 0, 0, 0, 0, 0,
	0, 1, 2, 0, 0, 0, 0, 0,
	1, 2, 0, 0, 0, 0, 0, 0,
	0, 2, 0, 0, 0, 0, 0, 0,
	2, 0, 0, 0, 0, 0, 0, 0,
	0, 1, 0, 0, 0, 0, 0, 0,
	1, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
};

static inline uint32_t _avx_unique_store(__m256i old, __m256i newval, uint32_t *output)
{
	__m256i recon = _mm256_blend_epi32(old, newval, 0b01111111);
	const __m256i movebyone_mask = _mm256_set_epi32(6, 5, 4, 3, 2, 1, 0, 7); // rotate shuffle
	__m256i vecTmp = _mm256_permutevar8x32_epi32(recon, movebyone_mask);
	uint32_t M = _mm256_movemask_ps((__m256)_mm256_cmpeq_epi32(vecTmp, newval));
	uint32_t numberofnewvalues = sizeof(__m256i) / sizeof(uint32_t) -
				     (uint32_t)_mm_popcnt_u32(M);
	__m256i key = _mm256_loadu_si256((const __m256i *)uniqshuf + M);
	__m256i val = _mm256_permutevar8x32_epi32(newval, key);
	_mm256_storeu_si256((__m256i *)output, val);
	return numberofnewvalues;
}

static size_t avx_unique(uint32_t *out, size_t len)
{
	__m256i old = _mm256_set1_epi32(out[0] - 1);
	uint32_t *outbegin = out;
	uint32_t *outend = out + len;
	uint32_t *output = out;
	while(out + sizeof(__m256i) / sizeof(uint32_t) <= outend) {
		__m256i newval = _mm256_loadu_si256((const __m256i *) out);
		output += _avx_unique_store(old, newval, output);
		old = newval;
		out += sizeof(__m256i) / sizeof(uint32_t);
	}
	uint32_t oldv = *(output - 1);
	while(out < outend) {
		uint32_t newv = *out;
		if(newv != oldv) {
			*output = newv;
			output++;
		}
		oldv = newv;
		out++;
	}
	return output - outbegin;
}

void uniq(uint32_t *buf, size_t *n)
{
	if (*n <= 1)
		return;

	uint32_qsort(buf, *n);

	*n = avx_unique(buf, *n);
}

#else

void uniq(uint32_t *buf, size_t *n)
{
	size_t i = 0, j;

	if (*n <= 1)
		return;

	uint32_qsort(buf, *n);

	/* reduce by removing duplicates */
	for (j = 1; j < *n; ++j) {
		if (buf[j] != buf[i])
			buf[++i] = buf[j];
	}

	*n = i + 1;
}

#endif  /* defined(__AVX2__) */
